<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Editor</title>
    <style>
        input, button {
            margin-bottom: 10px;
        }
    </style>
    <script>
        function addRow() {
            const table = document.getElementById("jsonTable");
            const row = table.insertRow(-1);
            const keyCell = row.insertCell(0);
            const valueCell = row.insertCell(1);
            const actionCell = row.insertCell(2);

            const keyInput = document.createElement('input');
            keyInput.type = 'text';
            keyInput.className = 'key';
            keyInput.onblur = () => validateKey(keyInput);
            keyInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextValueInput = e.target.parentNode.nextElementSibling.firstElementChild;
                    nextValueInput.focus();
                }
            };

            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.className = 'value';
            valueInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addRow();
                    const newRow = table.rows[table.rows.length - 1];
                    newRow.cells[0].firstElementChild.focus();
                }
            };

            const keyCheckbox = document.createElement('input');
            keyCheckbox.type = 'checkbox';
            keyCheckbox.className = 'key-checkbox';
            keyCheckbox.onchange = () => {
                if (!keyCheckbox.checked) {
                    valueCheckbox.checked = false;
                }
            };

            const valueCheckbox = document.createElement('input');
            valueCheckbox.type = 'checkbox';
            valueCheckbox.className = 'value-checkbox';
            valueCheckbox.onchange = () => {
                if (valueCheckbox.checked) {
                    keyCheckbox.checked = true;
                }
            };

            keyCell.prepend(keyCheckbox);
            valueCell.prepend(valueCheckbox);

            keyCell.appendChild(keyInput);
            valueCell.appendChild(valueInput);
            actionCell.innerHTML = '<button onclick="deleteRow(this)">Delete</button>';
        }

        function deleteRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function validateKey(input) {
            const keys = document.getElementsByClassName("key");
            for (let i = 0; i < keys.length; i++) {
                if (keys[i] !== input && keys[i].value === input.value) {
                    alert("Duplicate keys are not allowed!");
                    input.setCustomValidity("Duplicate keys are not allowed!");
                    return;
                }
            }
            input.setCustomValidity("");
        }

        function resetFields() {
            const table = document.getElementById("jsonTable");
            const keys = document.getElementsByClassName("key");
            const values = document.getElementsByClassName("value");
            const keyCheckboxes = document.getElementsByClassName("key-checkbox");
            const valueCheckboxes = document.getElementsByClassName("value-checkbox");

            for (let i = keys.length - 1; i >= 0; i--) {
                if (!keyCheckboxes[i].checked) {
                    table.deleteRow(i);
                } else {
                    if (!valueCheckboxes[i].checked) {
                        values[i].value = "";
                    }
                }
            }
        }


        async function submitForm() {
            const json = {};
            const keys = document.getElementsByClassName("key");
            const values = document.getElementsByClassName("value");

            for (let i = 0; i < keys.length; i++) {
                const key = keys[i].value;
                let value = values[i].value;

                try {
                    value = JSON.parse(value);
                } catch (e) {
                    const lowerCase = value.toLowerCase();
                    if (lowerCase === 'true') {
                        value = true;
                    } else if (lowerCase === 'false') {
                        value = false;
                    } else if (lowerCase == 'null' || lowerCase == 'none') {
                        value = null;
                    } else {
                        // Leave value as string
                    }
                }

                json[key] = value;
            }

            const response = await fetch('/process-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(json)
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    document.getElementById("result").innerText = "JSON processed successfully!";
                    resetFields(); // Add this line to reset the fields
                } else {
                    const errors = result.errors.join("\n");
                    document.getElementById("result").innerText = `Error processing JSON:\n${errors}`;
                }
            } else {
                document.getElementById("result").innerText = "Error sending JSON data.";
            }
        }
    </script>
</head>
<body>
    <h1>JSON Editor</h1>
    <table id="jsonTable">
    </table>
    <button onclick="addRow()">Add Key-Value Pair</button>
    <button onclick="submitForm()">Submit</button>
    <h2>Result</h2>
    <pre id="result"></pre>
</body>
</html>
